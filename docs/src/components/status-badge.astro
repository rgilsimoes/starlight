---
import { Icon } from '@astrojs/starlight/components';
import { getEntry } from 'astro:content';
import {
	localizedSlug,
	slugToLocaleData,
	urlToSlug,
} from '../../../packages/starlight/utils/slugs';

// TODO - This file is generated by the `lunaria` CLI command and is usually located in the ./dist/lunaria directory.
// Read a `lunaria-status.json` file from the file system.
import globalStatus from '../assets/lunaria-status.json';

// TODO - Can we retrieve the docs path some other way?
const BASE_DOCS_PATH = 'src/content/docs/';

// The current page default localized slug.
const localized = urlToSlug(Astro.url);
const originalSlug = localizedSlug(localized, undefined);
const defaultLocaleLink = '/' + originalSlug + '/';
const entry = await getEntry('docs', originalSlug || '/');

// Get the current page status
const currentDocFile = BASE_DOCS_PATH + entry?.id;
const currentPageStatus: any = globalStatus.find((status) => status.sharedPath === currentDocFile);
const currentLocale = slugToLocaleData(localized).locale;

// Generate a localization status
let isOutdated = false;

if (currentPageStatus && currentLocale) {
	if (currentPageStatus?.localizations && currentPageStatus?.sourceFile.isLocalizable) {
		const localization = currentPageStatus?.localizations[currentLocale as any] as any;
		isOutdated = localization.isOutdated;
	}
}
---

{
	isOutdated && (
		<p class="sl-flex">
			<Icon name={'warning'} size="1.5em" color="var(--sl-color-orange-high)" />
			<span>
				This translation could be outdated, please check the{' '}
				<a href={defaultLocaleLink}>original</a>.
			</span>
		</p>
	)
}

<style>
	p {
		border: 1px solid var(--sl-color-red);
		padding: 0.75em 1em;
		background-color: var(--sl-color-red-low);
		color: var(--sl-color-red-high);
		width: max-content;
		max-width: 100%;
		align-items: center;
		gap: 0.75em;
		font-size: var(--sl-text-body-sm);
		line-height: var(--sl-line-height-headings);
	}
</style>
